name: CD - Staging + Production

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

env:
  PHP_VERSION: '8.4'
  NODE_VERSION: '20'
  DEPLOY_DIR: '/var/www/comprasventas'

jobs:

  # ============================================================
  # JOB 1: BUILD
  # ============================================================
  build:
    name: Build Application
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, bcmath, xml, ctype, json, tokenizer, curl, mysql, zip, pgsql, pdo_pgsql
          coverage: none

      - name: Cache Composer Dependencies
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-prod-${{ runner.os }}-${{ hashFiles('composer.lock') }}
          restore-keys: |
            composer-prod-${{ runner.os }}-

      - name: Install Composer dependencies
        run: composer update -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install NPM dependencies
        run: npm ci

      - name: Build Assets
        run: |
          npm run build
          echo "Assets built successfully."

      - name: Create deployment artifact
        run: |
          mkdir -p deployment
          tar -czf deployment/release-${{ github.sha }}.tar.gz \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='.env' \
            --exclude='.env.local' \
            --exclude='storage/app/*' \
            --exclude='storage/logs/*' \
            --exclude='storage/framework/cache/data/*' \
            --exclude='storage/framework/sessions/*' \
            --exclude='storage/framework/views/*' \
            --exclude='tests' \
            --exclude='*.md' \
            --exclude='.github' \
            --exclude='.editorconfig' \
            --exclude='.gitignore' \
            --exclude='.gitattributes' \
            --exclude='phpunit.xml' \
            --exclude='vitest.config.js' \
            --exclude='eslint.config.js' \
            --exclude='.claude' \
            .

      - name: Setup Environment for Optimization
        run: |
          cp .env.example .env
          php artisan key:generate

      - name: Optimize Laravel
        run: |
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          echo "Laravel optimized successfully."

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ github.sha }}
          path: deployment/release-${{ github.sha }}.tar.gz
          retention-days: 7
          
      # Summary
      - name: Build Summary
        run: |
          echo "## Build & Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Artifact** | \`release-${{ github.sha }}.tar.gz\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Release created successfully!" >> $GITHUB_STEP_SUMMARY

  # ============================================================
  # JOB 2: DEPLOY TO STAGING
  # ============================================================
  stage:
    name: Deploy to Staging
    if: github.ref == 'refs/heads/main'
    runs-on: self-hosted

    environment: staging
    needs: build

    steps:
      - name: Download deployment artifact
        uses: actions/download-artifact@v4
        with:
          name: release-${{ github.sha }}
      
      - name: Predeploy Checks on Staging Server
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          password: ${{ secrets.STAGING_PASSWORD }}
          script: |
            RELEASE_DIR="${{ secrets.STAGING_DEPLOY_DIR }}/releases/${{ github.sha }}"
            echo "Running pre-deployment checks..."

            echo "Creating release directory: $RELEASE_DIR"
            mkdir -p $RELEASE_DIR          

            # Check shared directory
            if [ ! -d "${{ secrets.STAGING_DEPLOY_DIR }}/shared" ]; then
              echo "Creating shared directory..."
              mkdir -p "${{ secrets.STAGING_DEPLOY_DIR }}/shared"
            fi
            echo "Shared directory exists."

            # Check .env file
            if [ ! -f "${{ secrets.STAGING_DEPLOY_DIR }}/shared/.env" ]; then
              echo "Creating .env file..."
              echo "${{ secrets.STAGING_ENV_CONTENT }}" > "${{ secrets.STAGING_DEPLOY_DIR }}/shared/.env"
            fi
            echo ".env file exists."            

            echo "Pre-deployment checks completed."
      
      - name: Transfer Release Artifact to Staging Server
        run: |
          rsync -avz release-${{ github.sha }}.tar.gz \
          ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }}:${{ secrets.STAGING_DEPLOY_DIR }}/releases/${{ github.sha }}/

      - name: Deploy Application on Staging Server
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          password: ${{ secrets.STAGING_PASSWORD }}
          script: |
            RELEASE_DIR="${{ secrets.STAGING_DEPLOY_DIR }}/releases/${{ github.sha }}"
            RELEASE_FILE="release-${{ github.sha }}.tar.gz"

            echo "Extracting release artifact..."
            cd $RELEASE_DIR
            tar -xzf $RELEASE_FILE
            rm $RELEASE_FILE
            echo "Extraction completed."

            echo "Creating symlinks..."
            rm -rf storage
            ln -sfn ${{ secrets.STAGING_DEPLOY_DIR }}/shared/storage $RELEASE_DIR/storage
            ln -sfn ${{ secrets.STAGING_DEPLOY_DIR }}/shared/.env $RELEASE_DIR/.env
            echo "Symlinks created."

            echo "Running Migrations..."
            php artisan migrate --force

            echo "Updating current symlink..."
            ln -sfn $RELEASE_DIR ${{ secrets.STAGING_DEPLOY_DIR }}/current

            echo "Deployment to staging server completed."

      - name: Verify Staging Deployment
        run: curl -f "${{ secrets.STAGING_APP_URL }}/api/health"

  # ============================================================
  # JOB 3: DEPLOY TO PRODUCTION
  # ============================================================
  production:
    name: Deploy to Production
    runs-on: self-hosted
    needs: stage
    environment: production
    steps:
      - name: Download deployment artifact
        uses: actions/download-artifact@v4
        with:
          name: release-${{ github.sha }}

      - name: Predeploy Checks on Production Server
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          password: ${{ secrets.PROD_PASSWORD }}
          script: |
            RELEASE_DIR="${{ secrets.PROD_DEPLOY_DIR }}/releases/${{ github.sha }}"

            echo "Running pre-deployment checks..."

            echo "Creating release directory: $RELEASE_DIR"
            mkdir -p $RELEASE_DIR          

            # Check shared directory
            if [ ! -d "${{ secrets.PROD_DEPLOY_DIR }}/shared" ]; then
              echo "Creating shared directory..."
              mkdir -p "${{ secrets.PROD_DEPLOY_DIR }}/shared"
            fi
            echo "Shared directory exists."

            # Check .env file
            if [ ! -f "${{ secrets.PROD_DEPLOY_DIR }}/shared/.env" ]; then
              echo "Creating .env file..."
              echo "${{ secrets.PROD_ENV_CONTENT }}" > "${{ secrets.PROD_DEPLOY_DIR }}/shared/.env"
            fi
            echo ".env file exists"            

            echo "Pre-deployment checks completed."
      
      - name: Transfer Release Artifact to Production Server
        run: |
          RELEASE_NAME="${{ github.sha }}"
          rsync -avz release-$RELEASE_NAME.tar.gz \
          ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }}:${{ secrets.PROD_DEPLOY_DIR }}/releases/$RELEASE_NAME/

      - name: Deploy Application on Production Server
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          password: ${{ secrets.PROD_PASSWORD }}
          script: |
            RELEASE_DIR="${{ secrets.PROD_DEPLOY_DIR }}/releases/${{ github.sha }}"
            RELEASE_FILE="release-${{ github.sha }}.tar.gz"

            echo "Extracting release artifact..."
            cd $RELEASE_DIR
            tar -xzf $RELEASE_FILE
            rm $RELEASE_FILE
            echo "Extraction completed."

            echo "Creating symlinks..."
            rm -rf storage
            ln -sfn ${{ secrets.PROD_DEPLOY_DIR }}/shared/storage $RELEASE_DIR/storage
            ln -sfn ${{ secrets.PROD_DEPLOY_DIR }}/shared/.env $RELEASE_DIR/.env
            echo "Symlinks created."

            echo "Running Migrations..."
            php artisan migrate --force

            echo "Updating current symlink..."
            ln -sfn $RELEASE_DIR ${{ secrets.PROD_DEPLOY_DIR }}/current

            echo "Deployment to production server completed."

  rollback_staging:
    name: Rollback staging
    if: failure()
    runs-on: self-hosted
    needs: stage
    environment: staging
    steps:
      - name: Deploy Application on Staging Server
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          password: ${{ secrets.STAGING_PASSWORD }}
          script: |
            PREV=\$(ls -1dt ${{ secrets.STAGING_DEPLOY_DIR }}/releases/*/ | sed -n '2p' | tr -d '/')
            [ -n \"\$PREV\" ]
            ln -sfn \$PREV ${{ secrets.STAGING_DEPLOY_DIR }}/current

  rollback_production:
    name: Rollback production
    if: failure()
    runs-on: self-hosted
    needs: production
    environment: production
    steps:
      - name: Deploy Application on Production Server
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          password: ${{ secrets.PROD_PASSWORD }}
          script: |
            PREV=\$(ls -1dt ${{ secrets.PROD_DEPLOY_DIR }}/releases/*/ | sed -n '2p' | tr -d '/')
            [ -n \"\$PREV\" ]
            ln -sfn \$PREV ${{ secrets.PROD_DEPLOY_DIR }}/current